{"version":3,"sources":["js/imageloader.js"],"names":["imgInput","document","getElementById","resizeImage","canvas","newCanvas","newWidth","canvasContext","getContext","newCanvasContext","imageData","getImageData","width","height","console","log","oldWidth","oldHeight","blockWidth","Math","floor","newHeight","newData","ImageData","data","i","j","averageColor","x","y","pixel","getPixelColors","component","round","putImageData","grayscale","contrast","levels","brickCanvas","querySelector","showBricks","mapDataToBricks","coordR","length","avg","alpha","avgNonTransparent","coef","max","reduce","acc","val","idx","min","contr","mapArray","brickColor","forEach","el","addEventListener","e","target","files","imageFile","reader","FileReader","readAsDataURL","onloadend","myImage","Image","src","result","onload","ev","virtualCanvas","createElement","virtualContext","drawImage","defaultMappingTemplate","id","border","mappingTemplate","mappedData","mapping","brickIndex","brickSize","ctx","map","grayColor","channel","find","toString","padStart","fillStyle","raw","column","fillRect"],"mappings":"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","file":"imageloader.ee290038.js","sourceRoot":"../src","sourcesContent":["const imgInput = document.getElementById('imageInput');\nimgInput.addEventListener('change', function (e) {\n  if (e.target.files) {\n    let imageFile = e.target.files[0]; //here we get the image file\n    let reader = new FileReader();\n    reader.readAsDataURL(imageFile);\n    reader.onloadend = function (e) {\n      let myImage = new Image(); // Creates image object\n      myImage.src = e.target.result; // Assigns converted image to image object\n      myImage.onload = function (ev) {\n        let virtualCanvas = document.createElement('canvas'); // Creates a canvas object\n        let virtualContext = virtualCanvas.getContext('2d'); // Creates a contect object\n        virtualCanvas.width = myImage.width; // Assigns image's width to canvas\n        virtualCanvas.height = myImage.height; // Assigns image's height to canvas\n        virtualContext.drawImage(myImage, 0, 0); // Draws the image on canvas\n        // let imgData = virtualCanvas.toDataURL('image/jpeg', 0.75); // Assigns image base64 string in jpeg format to a variable\n\n        let myCanvas = document.getElementById('myCanvas'); // Creates a canvas object\n        // let myContext = myCanvas.getContext('2d'); // Creates a contect object\n        // myContext.drawImage(newImage, 0, 0); // Draws the image on canvas\n        resizeImage(virtualCanvas, myCanvas, 90);\n      };\n    };\n  }\n});\n\nfunction resizeImage(canvas, newCanvas, newWidth) {\n  const canvasContext = canvas.getContext('2d');\n  const newCanvasContext = newCanvas.getContext('2d');\n  // 1. Count the amount of pixels in a block\n  const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);\n  console.log('imageData = ', imageData);\n  const oldWidth = imageData.width;\n  const oldHeight = imageData.height;\n  const blockWidth = Math.floor(oldWidth / newWidth) || 1;\n  const newHeight = Math.floor(oldHeight / blockWidth);\n  console.log('block width = ', blockWidth);\n  console.log('new dimensions = ', newWidth, 'x', newHeight);\n  // 2. Read block by coords\n  const newData = new ImageData(newWidth, newHeight);\n  const { data } = newData;\n  for (let i = 0; i < newWidth; i += 1) {\n    for (let j = 0; j < newHeight; j += 1) {\n      const averageColor = [0, 0, 0, 0];\n      for (let x = i * blockWidth; x < (i + 1) * blockWidth; x += 1) {\n        for (let y = j * blockWidth; y < (j + 1) * blockWidth; y += 1) {\n          const pixel = getPixelColors(x, y, imageData);\n          // 3. Count average color of block}\n          let component = 0;\n          while (component < 4) {\n            averageColor[component] += pixel[component] / blockWidth ** 2;\n            component += 1;\n          }\n        }\n      }\n      let component = 0;\n      while (component < 4) {\n        data[i * 4 + j * newWidth * 4 + component] = Math.round(averageColor[component]);\n        component += 1;\n      }\n    }\n  }\n  console.log(newData);\n  // 4. Draw image\n  newCanvas.width = newWidth * 2;\n  newCanvas.height = newHeight * 2;\n  newCanvasContext.putImageData(newData, 0, 0);\n  grayscale(data);\n  newCanvasContext.putImageData(newData, newWidth, 0);\n  contrast(data, 2.5);\n  newCanvasContext.putImageData(newData, 0, newHeight);\n  levels(data);\n  newCanvasContext.putImageData(newData, newWidth, newHeight);\n\n  const brickCanvas = document.querySelector('#brickCanvas');\n  const bricks = mapDataToBricks(data, newWidth);\n  showBricks(bricks, brickCanvas);\n}\n\nfunction getPixelColors(x, y, imageData) {\n  const coordR = y * (imageData.width * 4) + x * 4;\n  const red = imageData.data[coordR];\n  const green = imageData.data[coordR + 1];\n  const blue = imageData.data[coordR + 2];\n  const alpha = imageData.data[coordR + 3];\n  return [red, green, blue, alpha];\n}\n\nfunction grayscale(data) {\n  for (let i = 0; i < data.length; i += 4) {\n    const avg = Math.round((data[i] + data[i + 1] + data[i + 2]) / 3);\n    const alpha = data[i + 3];\n    const avgNonTransparent = (avg * alpha) / 255 + 255 - alpha;\n    data[i] = avgNonTransparent; // red\n    data[i + 1] = avgNonTransparent; // green\n    data[i + 2] = avgNonTransparent; // blue\n    data[i + 3] = 255; // alpha\n  }\n}\n\nfunction contrast(data, coef = 1) {\n  let max = data.reduce((acc, val, idx) => ((idx + 1) % 4 ? (val > acc ? val : acc) : acc), 0);\n  let min = data.reduce((acc, val, idx) => ((idx + 1) % 4 ? (val < acc ? val : acc) : acc), 255);\n  console.log('min = ', min, ', max = ', max, ', coef = ', coef);\n  min = Math.round(min * coef);\n  max = Math.round(255 - (255 - max) * coef);\n  min = min > 47 ? 47 : min;\n  max = max < 160 ? 160 : max;\n  console.log('min = ', min, ', max = ', max);\n  if (min === max || (min === 0 && max === 255)) return;\n  for (let i = 0; i < data.length; i += 4) {\n    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;\n    let contr = Math.round((avg - min) * (255 / (max - min)));\n    contr = contr > 255 ? 255 : contr;\n    data[i] = contr; // red\n    data[i + 1] = contr; // green\n    data[i + 2] = contr; // blue\n  }\n}\n\nfunction levels(data, mapArray = [63, 127, 191, 255]) {\n  for (let i = 0; i < data.length; i += 4) {\n    const avg = Math.round((data[i] + data[i + 1] + data[i + 2]) / 3);\n    let brickColor = 0;\n    mapArray.forEach(el => {\n      if (avg >= el - 16 && el > brickColor) brickColor = el;\n    });\n    data[i] = brickColor; // red\n    data[i + 1] = brickColor; // green\n    data[i + 2] = brickColor; // blue\n  }\n}\n\nconst defaultMappingTemplate = [\n  { id: 0, border: 0 },\n  { id: 1, border: 47 },\n  { id: 2, border: 111 },\n  { id: 3, border: 175 },\n  { id: 4, border: 239 },\n];\n\nfunction mapDataToBricks(data, width, mappingTemplate = defaultMappingTemplate) {\n  const mappedData = { data: [], width, mapping: mappingTemplate }; // output format\n  for (let i = 0; i * 4 < data.length; i += 1) {\n    const avg = Math.round((data[i * 4] + data[i * 4 + 1] + data[i * 4 + 2]) / 3);\n    let brickIndex = 0;\n    mappingTemplate.forEach(el => {\n      if (avg >= el.border && el.id > brickIndex) brickIndex = el.id;\n    });\n    mappedData.data[i] = brickIndex;\n  }\n  return mappedData;\n}\n\nfunction showBricks({ data, width, mapping }, canvas, brickSize = 16) {\n  const ctx = canvas.getContext('2d');\n  canvas.width = width * brickSize;\n  canvas.height = (data.length / width) * brickSize;\n  data.map((val, idx) => {\n    const grayColor = mapping.find(el => el.id === val)?.border || 0;\n    const channel = grayColor.toString(16).padStart(2, '0');\n    ctx.fillStyle = '#' + channel + channel + channel;\n    const raw = idx % width;\n    const column = Math.floor(idx / width);\n    ctx.fillRect(raw * brickSize, column * brickSize, brickSize - 1, brickSize - 1);\n  });\n}\n"]}